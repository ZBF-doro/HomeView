{% extends "base.html" %}

{% block title %}数据操作 - 链家网房屋数据分析系统{% endblock %}

{% block content %}
<div class="content">
    <div class="card">
        <div class="card-header">
            <h5>数据操作</h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-primary" id="addHouseBtn">
                                <i class="fas fa-plus me-2"></i> 添加房屋
                            </button>
                        </div>
                        <div>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="搜索房屋信息" id="searchInput"
                                       value="{{ keyword }}">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <!-- 添加清除搜索按钮 -->
                                {% if keyword %}
                                <button class="btn btn-outline-danger" type="button" id="clearSearchButton">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <!-- 添加搜索结果信息 -->
                    {% if keyword %}
                    <div class="alert alert-info mb-3">
                        搜索关键词: <strong>{{ keyword }}</strong> |
                        共找到 <strong>{{ pagination.total }}</strong> 条记录
                    </div>
                    {% endif %}

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">名称</th>
                                <th scope="col">城市</th>
                                <th scope="col">区域</th>
                                <th scope="col">地址</th>
                                <th scope="col">户型</th>
                                <th scope="col">面积范围</th>
                                <th scope="col">价格</th>
                                <th scope="col">装修</th>
                                <th scope="col">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for house in houses %}
                            <tr>
                                <td>{{ house.id }}</td>
                                <td>{{ house.title }}</td>
                                <td>{{ house.city }}</td>
                                <td>{{ house.region }}</td>
                                <td>{{ house.address }}</td>
                                <td>{{ house.hourseType }}</td>
                                <td>{{ house.area_range }}</td>
                                <td>{{ house.price }}</td>
                                <td>{{ house.hourseDecoration }}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning edit-house" data-id="{{ house.id }}">
                                        <i class="fas fa-edit me-1"></i> 编辑
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-house" data-id="{{ house.id }}">
                                        <i class="fas fa-trash me-1"></i> 删除
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center">
                                    {% if keyword %}
                                    没有找到匹配的房屋数据
                                    {% else %}
                                    暂无房屋数据
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{{ url_for('page.data_operation', page=pagination.prev_num, keyword=keyword) }}"
                                   aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&laquo;</span>
                            </li>
                            {% endif %}

                            {% for page_num in pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num == pagination.page %}
                                    <li class="page-item active"><a class="page-link"
                                                                   href="{{ url_for('page.data_operation', page=page_num, keyword=keyword) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item"><a class="page-link"
                                                           href="{{ url_for('page.data_operation', page=page_num, keyword=keyword) }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}

                            {% if pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{{ url_for('page.data_operation', page=pagination.next_num, keyword=keyword) }}"
                                   aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&raquo;</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑房屋模态框 -->
    <div class="modal fade" id="houseModal" tabindex="-1" aria-labelledby="houseModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="houseModalLabel">添加房屋</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="houseForm" novalidate>
                        <input type="hidden" id="houseId" name="id">

                        <div class="mb-3">
                            <label for="title" class="form-label">标题</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                            <div class="invalid-feedback">请输入标题</div>
                        </div>

                        <div class="mb-3">
                            <label for="city" class="form-label">城市</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                            <div class="invalid-feedback">请输入城市</div>
                        </div>

                        <div class="mb-3">
                            <label for="region" class="form-label">区域</label>
                            <input type="text" class="form-control" id="region" name="region" required>
                            <div class="invalid-feedback">请输入区域</div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">地址</label>
                            <input type="text" class="form-control" id="address" name="address" required>
                            <div class="invalid-feedback">请输入地址</div>
                        </div>

                        <div class="mb-3">
                            <label for="price" class="form-label">价格</label>
                            <input type="text" class="form-control" id="price" name="price" required>
                            <div class="invalid-feedback">请输入价格</div>
                        </div>

                        <div class="mb-3">
                            <label for="hourseType" class="form-label">户型</label>
                            <input type="text" class="form-control" id="hourseType" name="hourseType">
                        </div>

                        <div class="mb-3">
                            <label for="area_range" class="form-label">面积范围</label>
                            <input type="text" class="form-control" id="area_range" name="area_range">
                        </div>

                        <div class="mb-3">
                            <label for="hourseDecoration" class="form-label">装修</label>
                            <input type="text" class="form-control" id="hourseDecoration" name="hourseDecoration">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveHouseBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 添加房屋按钮点击事件
        document.getElementById('addHouseBtn').addEventListener('click', function () {
            document.getElementById('houseModalLabel').textContent = '添加房屋';
            document.getElementById('houseForm').reset();
            document.getElementById('houseId').value = '';
            new bootstrap.Modal(document.getElementById('houseModal')).show();
        });

        // 编辑房屋按钮点击事件
        document.querySelectorAll('.edit-house').forEach(button => {
            button.addEventListener('click', function () {
                const houseId = this.getAttribute('data-id');
                fetch("{{ url_for('page.get_house', house_id=0) }}".replace('0', houseId))
                   .then(response => response.json())
                   .then(house => {
                        document.getElementById('houseModalLabel').textContent = '编辑房屋';
                        document.getElementById('houseId').value = house.id;
                        document.getElementById('title').value = house.title;
                        document.getElementById('city').value = house.city;
                        document.getElementById('region').value = house.region;
                        document.getElementById('address').value = house.address;
                        document.getElementById('price').value = house.price;
                        document.getElementById('hourseType').value = house.hourseType;
                        document.getElementById('area_range').value = house.area_range;
                        document.getElementById('hourseDecoration').value = house.hourseDecoration;
                        new bootstrap.Modal(document.getElementById('houseModal')).show();
                    })
                   .catch(error => {
                        console.error('获取房屋数据失败:', error);
                        alert('获取房屋数据失败，请重试');
                    });
            });
        });

        // 保存房屋按钮点击事件
        document.getElementById('saveHouseBtn').addEventListener('click', function () {
            const houseId = document.getElementById('houseId').value;
            const formData = {
                title: document.getElementById('title').value,
                city: document.getElementById('city').value,
                region: document.getElementById('region').value,
                address: document.getElementById('address').value,
                price: document.getElementById('price').value,
                hourseType: document.getElementById('hourseType').value,
                area_range: document.getElementById('area_range').value,
                hourseDecoration: document.getElementById('hourseDecoration').value
            };

            // 表单验证
            const requiredFields = ['title', 'city', 'region', 'address', 'price'];
            let isValid = true;

            requiredFields.forEach(field => {
                const input = document.getElementById(field);
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!isValid) return;

            // 使用url_for生成API路径
            const url = houseId
                ? "{{ url_for('page.update_house', house_id=0) }}".replace('0', houseId)
                : "{{ url_for('page.add_house') }}";
            const method = houseId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === '更新成功' || data.id) {
                    alert(houseId ? '更新成功' : '添加成功');
                    new bootstrap.Modal(document.getElementById('houseModal')).hide();
                    location.reload();
                } else {
                    alert('操作失败，请重试');
                }
            })
            .catch(error => {
                console.error('保存房屋数据失败:', error);
                alert('保存房屋数据失败，请重试');
            });
        });

        // 删除房屋按钮点击事件
        document.querySelectorAll('.delete-house').forEach(button => {
            button.addEventListener('click', function () {
                const houseId = this.getAttribute('data-id');
                if (confirm('确定要删除这个房屋信息吗？')) {
                    fetch("{{ url_for('page.delete_house', house_id=0) }}".replace('0', houseId), {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === '删除成功') {
                            alert('删除成功');
                            location.reload();
                        } else {
                            alert('删除失败，请重试');
                        }
                    })
                    .catch(error => {
                        console.error('删除房屋数据失败:', error);
                        alert('删除房屋数据失败，请重试');
                    });
                }
            });
        });

        // 搜索功能
        document.getElementById('searchButton').addEventListener('click', function () {
            const keyword = document.getElementById('searchInput').value;
            window.location.href = "{{ url_for('page.data_operation') }}?keyword=" + encodeURIComponent(keyword);
        });

        document.getElementById('searchInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                document.getElementById('searchButton').click();
            }
        });

        // 清除搜索功能
        {% if keyword %}
        document.getElementById('clearSearchButton').addEventListener('click', function () {
            window.location.href = "{{ url_for('page.data_operation') }}";
        });
        {% endif %}
    });
</script>

{% endblock %}